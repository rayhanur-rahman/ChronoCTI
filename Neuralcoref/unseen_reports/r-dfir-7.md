# Case Summary

The intrusion started with a contact form on a website. It has been reported that this delivery method has been in use for intrusions since at least 2020. This campaign took place in May, and appears to have run as late as June 2022, based on OSINT data related to similar delivery fingerprints. The contact form gets filled out by the threat actor with a Copyright notice, purporting a violation of the Digital Millennium Copyright Act (DMCA). It then encourages the recipient to download a file showing the purported violation.

Upon the user clicking the link, they arrive at a “Google” storage site on storage.googleapis.com. A zip file is then downloaded to the victim machine and once unzipped the user is presented with an ISO file. The ISO contains a LNK file and a DLL file. When the LNK is double-clicked, the BumbleBee DLL is executed via rundll32. Initially, contact was made with BumbleBee command and control servers but little other early activity was observed.

Approximately 12 hours later, ImagingDevices.exe was launched via WmiPrivse.exe and a Meterpreter agent was injected into the process, like we have observed in previous reports. This process then utilized nltest, net, tasklist, and whoami to perform reconnaissance. About 37 minutes after launching ImagingDevices.exe, the Meterpreter agent migrated to svchost.exe. Upon migrating to the svchost process, there were attempts to bypass UAC and launch a Meterpreter executable.

Several failed attempts to bypass UAC occurred, utilizing the WSReset method, followed by a failed attempt to bypass UAC utilizing the slui hijacking method. Finally, the threat actors succeeded on their final attempt, using the WSReset method. Once UAC was bypassed, Meterpreter’s getsystem command was successfully employed. Now in the SYSTEM context, this Meterpreter agent executed a Cobalt Strike Beacon DLL.

The Cobalt Strike Beacon was utilized to perform a second round of reconnaissance and to access credentials. AdFind, nltest, net, and systeminfo were used to facilitate this activity. The Sysinternals tool ProcDump64 was written to disk and used to dump lsass on the beachhead host. Then, the threat actors executed reg.exe to save a copy of the SAM , Security , and Software registry hives on the beachhead host. Lateral movement was then performed over SMB, to transfer a Cobalt Strike Beacon DLL’s to other workstation’s C$\\ProgramData\. These were executed via remote services, but appeared to be there for redundant connections as the threat actors continued to perform their actions on the beachhead workstation.

After a pause of about three hours, 19 hours since initial access, the threat actors launched an exploit against the primary domain controller targeting the Zerologon (CVE 2020 1472) vulnerability. After successfully exploiting the Domain controller, the threat actors used Pass the Hash to begin working in the context of a user who was a member of the Domain Admins group.

From the beachhead host, Invoke-Sharefinder was executed with the output being written to disk. A Cobalt Strike Beacon DLL was then written over SMB to another Domain Controller and executed via a service.

The threat actors were evicted from the environment and no further impact was observed. We assess with medium confidence this intrusion was related to pre-ransomware activity due to the tool set and techniques the actors displayed. As far as impact, one Domain Controller was left broken causing authentication failures across the domain.

# Analysis

The intrusion in this case began with a link to a google domain, storage.googleapis.com. This delivery method has been observed in both thread hijacked email distribution, as well as contact form campaigns. We assess with medium-high confidence that the one observed in our intrusion was likely from a contact form campaign, as the initial access URL was spotted in the wild across various sites, impersonating various companies’ legal teams, trying to entice the user to download and review the malicious files.

After clicking the link, the users end up at what, at first glance, may appear to be a legitimate google download site.

Next, a zip file is downloaded to the victim’s system, which when unzipped reveals the ISO image file StolenImages_Evidence.iso , once mounted–lures the victim to open a shortcut mimicking a fake documents folder:

The LNK was pointing to the following command, which runs a malicious DLL when the user double clicks on the LNK file:

%windir%\system32\cmd.exe /c start rundll32.exe mkl2n.dll,kXlNkCKgFC

By extracting LNK metadata using Eric Zimmerman’s LECmd tool, we noticed that the initial BumbleBee payload was generated by the same threat actors reported in our previous BumbleBee report:




The tracker database block details containing threat actor’s hostname, MAC Address, and other details are the exact same as seen our the last BumbleBee report. However, the payload was slightly modified (name and icon).

# Execution

The threat actors dropped and executed multiple payloads reaching out to different C2s. The graph below shows how the threat actors were able to pivot between C2s by either injecting into legitimate processes or dropping and executing new payloads.

Like in our previous BumbleBee report, we see the use of injection into a legitimate Windows executable.

C:\Program Files\Windows Photo Viewer\ImagingDevices.exe

And likewise, we see BumbleBee spawning these new processes using WmiPrvSE.exe.

The graphic below shows all payloads dropped, executed, or injected by the threat actors. Both Meterpreter and Cobalt Strike payloads were used during this intrusion.

# Privilege Escalation

The getsystem module was used to elevate access on the beachhead host.
cmd.exe /c echo wafrms > \\.\pipe\wafrms C:\Windows\system32\cmd.exe /c echo dec8f35bcbf > \\.\pipe\7fd13a

On the second day, a Netlogon spike was observed from the beachhead host to a domain controller.

This spike was made up of various netlogon requests (NetrServerReqChallenge, NetrServerAuthenticate2, NetrServerPasswordSet2) from the beachhead host to the primary domain controller.

A view of the traffic reveals that the threat actors had exploited CVE 2020 1472, otherwise known as ZeroLogon. In the PCAP below, we can see the packet where the exploit succeeds in resetting the credential to all zeros.

On the domain controller, a 4742 event was generated showing the beachhead host changing the password on the domain controller, matching the timestamps to the network data.

After exploiting Zerologon, the threat actors were also seen using Pass the Hash to begin working in the context of a user, who was a member of the Domain Admins group.

# Defense Evasion

# Process Injection

ImagingDevices.exe injection into “svchost.exe -k UnistackSvcGroup -s WpnUserService” using NtAllocateVirtualMemoryRemoteApiCall. Several other processes were injected into as seen below:

# UAC Bypass

The threat actors were observed bypassing UAC via WSReset and DelegateExecute, spawning new processes at a High integrity level.

While executing this UAC bypass, the threat actors seemed to be running into some kind of trouble during execution, which required them to try the technique several times and tried to kill one of their processes from a prior attempt.

In addition to the WSReset UAC bypass, the threat actors tried a method using slui.exe. The data points to use of the Meterpreter implementation here.[1]

# Indicator Removal on Host

The threat actors were also seen deleting a number of their tools which were previously dropped to perform various tactics:

# Named Pipe Usage

Throughout the intrusion, the injected Cobalt Strike Processes utilized various named pipes for inter-process communications. Many of these pipes used default Cobalt Strike pipe patterns.

Known Cobalt Strike pipes used:

We also saw the unusual named pipes coming from ImagingDevices.exe which was injected with Meterpreter below:

# Credential Access

# LSASS Dump

The threat actor dropped the Sysinternals executable procdump64.exe , which they then used to dump the lsass process. The command observed was:

procdump64.exe -accepteula -ma lsass.exe C:\ProgramData\lsass.dmp

# Registry Hives Dump

Using the Cobalt Strike beacon, injected in a svchost.exe process, the threat actors dumped SAM , SECURITY , and SYSTEM hives using the native reg.exe utility. Below are the commands that were used:
- C:\Windows\system32\cmd.exe /C reg.exe save hklm\sam c:\ProgramData\sam.hive 
- C:\Windows\system32\cmd.exe C:\Windows\system32\cmd.exe /C reg.exe save hklm\security c:\ProgramData\security.save 
- C:\Windows\system32\cmd.exe /C reg.exe save hklm\security c:\ProgramData\security.save 
- C:\Windows\system32\cmd.exe C:\Windows\system32\cmd.exe /C reg.exe save hklm\system c:\ProgramData\system.save 
- C:\Windows\system32\cmd.exe /C reg.exe save hklm\system c:\ProgramData\system.save

# Discovery

The Discovery phase was carried out in this case using both native Windows tools, and external tools such as AdFind and PowerSploit. Initial discovery was performed using various Windows utilities. After dumping the lsass.exe process on the beachhead machine, the threat actors then launched af.exe (AdFind) to find all user objects and computers in the domain.



System utilities used for discovery included:
- nltest /dclist:DOMAIN 
- net view /all 
- net group "Domain Computers" /domain 
- net group "domain Admins" /domain 
- whoami /groups echo %USERDOMAIN% ping -n 1 DOMAINCONTROLLER 
- systeminfo 
- tasklist

Throughout the intrusion, the threat actor kept on trying to view a file named sh.txt.

The file appears to have been the intended output for execution of the Invoke-ShareFinder command. Execution of the command was visible in the PowerShell 4103 and 4104 logs.

Invoke-Sharefoinder is a module in the PowerSploit framework. This command, in particular, can find (non-standard) shares on hosts in the local domain.

# Lateral Movement

The threat actors used the SMB protocol to move laterally after compromising the beachhead. They specifically copied the n23.dll (Cobalt Strike) file to the C:\ProgramData path and then ran it.

We can confirm that the file was copied and then launched via the new service by examining the various host’s system logs for event id 7045.

cmd.exe /c rundll32.exe C:\ProgramData\23.dll,AddProgram

# Command and Control

Threat actors used multiple command and control servers to interact with the compromised environment.

# BumbleBee C2


# Cobalt Strike

Cobalt Strike Server Config:

# Meterpreter


# Impact

After exploiting Zerologon on the domain controller, the threat actor tried a few more things and then took a break from the hands on keyboard portion of the intrusion. The threat actor was then evicted from the environment. During IR, it was found that the primary domain controller was unresponsive to domain authentication due to the exploit run against it, resulting in domain authentication breaking around the environment.

# MITRE ATT&CK DATASET
Malicious File – T1204.002

Windows Command Shell – T1059.003

PowerShell – T1059.001

Process Injection – T1055

File Deletion – T1070.004

LSASS Memory – T1003.001

Exploitation for Privilege Escalation – T1068

Lateral Tool Transfer – T1570

Valid Accounts – T1078

Service Execution – T1569.002

SMB/Windows Admin Shares – T1021.002

Remote System Discovery – T1018

Process Discovery – T1057

Domain Groups – T1069.002

Rundll32 – T1218.011

Domain Account – T1087.002

System Information Discovery – T1082

Security Account Manager – T1003.002

Network Share Discovery – T1135

Pass the Hash – T1550.002

Mark-of-the-Web Bypass – T1553.005

Bypass User Account Control – T1548.002

Web Protocols – T1071.001

Spearphishing Link – T1566.002

Masquerading – T1036

Internal case #13842

Share this: Twitter

LinkedIn

Reddit

Facebook

WhatsApp

